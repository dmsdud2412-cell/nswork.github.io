<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>2026 ê·¼íƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        /* [ì–´ì œ ë””ìì¸ 100% ìœ ì§€] */
        body { font-family: 'Pretendard', sans-serif; margin: 10px; background-color: #f8f9fa; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .tabs button { padding: 8px 20px; border: 1px solid #ddd; background: #eee; cursor: pointer; border-radius: 5px; font-weight: bold; }
        .tabs button.active { background: #d32f2f; color: white; border-color: #d32f2f; }
        .month-btn { padding: 5px 10px; border: 1px solid #ccc; background: white; cursor: pointer; border-radius: 3px; font-size: 11px; }
        .month-btn.active { background: #d32f2f !important; color: white !important; border: none; }

        .table-container { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; font-size: 11px; }
        th, td { border: 1px solid #ededed; padding: 2px 0; text-align: center; height: 22px; }
        thead th { background-color: #fcfcfc; font-weight: bold; }

        /* -----------------------------------------------------------
           [ë¹„ìœ¨ ì¡°ì • í•µì‹¬] 
           1~31ì¼(.col-day)ì„ ì•„ì£¼ ì¢ê²Œ(1.1%) ì„¤ì •í•˜ì—¬ ì™¼ìª½ìœ¼ë¡œ ë°”ì§ ë¶™ì´ê³ , 
           ë‚¨ì€ ê³µê°„(45%)ì„ ë¹„ê³ ë€(.col-note)ì— ë‹¤ ì£¼ì—ˆìŠµë‹ˆë‹¤.
        ----------------------------------------------------------- */
        .col-info { width: 5.5%; }    /* ì§€ì , ì„±ëª… */
        .col-stat { width: 3.2%; }    /* í†µê³„ ì •ë³´ */
        .col-day  { width: 1.15%; }   /* 1~31ì¼ (ìˆ«ìë§Œ ê²¨ìš° ë³´ì¼ ì •ë„ë¡œ ì¢ê²Œ) */
        .col-note { width: 45%; }     /* ë¹„ê³  (ì‚¬ì§„ í¬ê¸°ì˜ ì ˆë°˜, 31ì¼ ë°”ë¡œ ì˜†ì— ë¶™ìŒ) */

        .txt-red { color: #d32f2f !important; font-weight: bold; }
        .bg-pink { background-color: #fff0f0 !important; }
        .at-cell { cursor: pointer; }
        .at-cell:hover { background-color: #f1f3f5; }

        /* [ì–´ì œì™€ ë™ì¼] ì…ë ¥ì°½ ë° ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        .col-note input, select { width: 100%; border: none; background: transparent; font-size: 11px; outline: none; padding: 0 8px; box-sizing: border-box; }
        .footer-row td { background-color: #f8f9fa !important; color: #333 !important; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="font-size: 20px;">ğŸ—“ï¸ 2026 ê·¼íƒœ ê´€ë¦¬</h1>
        <div class="tabs">
            <button id="btn-manager" class="active" onclick="switchTab('manager')">ì§€ì ì¥</button>
            <button id="btn-staff" onclick="switchTab('staff')">ì§ì›</button>
        </div>
    </div>
    <div id="month-picker" style="display: flex; justify-content: center; gap: 4px; margin-bottom: 15px; align-items: center;"></div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th rowspan="4" class="col-info">ì§€ì </th>
                    <th rowspan="4" class="col-info">ì„±ëª…</th>
                    <th rowspan="4" class="col-stat">í•„ìˆ˜<br>ì—°ì°¨</th>
                    <th rowspan="4" class="col-stat">ì „ì›”<br>ë¯¸ì‚¬ìš©</th>
                    <th rowspan="4" class="col-stat">ë‚¨ì€<br>ì—°ì°¨</th>
                    <th rowspan="4" class="col-stat">ì†Œì§„ìœ¨</th>
                    <th colspan="32" id="month-title">ê·¼íƒœ í˜„í™©</th> 
                </tr>
                <tr id="row-dates"></tr>
                <tr id="row-weeks"></tr>
                <tr id="row-holidays"></tr>
            </thead>
            <tbody id="attendance-body"></tbody>
            <tfoot>
                <tr class="footer-row" id="row-vacation">
                    <td colspan="6" style="text-align:right; padding-right:10px;">íœ´ê°€ ì¸ì›</td>
                </tr>
                <tr class="footer-row" id="row-working">
                    <td colspan="6" style="text-align:right; padding-right:10px;">ê·¼ë¬´ ì¸ì›</td>
                </tr>
            </tfoot>
        </table>
    </div>

    <script>
        const GAN_URL = "https://script.google.com/macros/s/AKfycby42R57TUGVePyKRxfsFqeLuinCy0rxIVZudX2-Z1tERUpYCxJWw50EU0ZsqIrVGlWy/exec";
        let currentType = 'manager'; let currentMonth = 1; let masterData = { manager: [], staff: [] }; let lastFetchedAttendance = [];

        window.onload = () => { renderMonthPicker(); loadAllData(); };

        async function loadAllData() {
            try {
                const response = await fetch(GAN_URL);
                const res = await response.json();
                masterData.manager = []; masterData.staff = [];
                if(res.config) {
                    const targetCol = 4 + (currentMonth - 1); 
                    res.config.slice(1).forEach(row => {
                        const p = { branch: row[1], name: row[2], req: row[3], unused: row[targetCol] || 0 };
                        if (row[0] === 'manager') masterData.manager.push(p);
                        else masterData.staff.push(p);
                    });
                }
                lastFetchedAttendance = res.attendance || [];
                renderTable(lastFetchedAttendance);
            } catch (e) { console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); }
        }

        function renderTable(attendance) {
            document.getElementById('month-title').innerText = `${currentMonth}ì›” ê·¼íƒœ í˜„í™©`;
            const tbody = document.getElementById('attendance-body');
            const dateRow = document.getElementById('row-dates');
            const weekRow = document.getElementById('row-weeks');
            const holidayRow = document.getElementById('row-holidays');
            const vRow = document.getElementById('row-vacation');
            const wRow = document.getElementById('row-working');

            tbody.innerHTML = ''; dateRow.innerHTML = ''; weekRow.innerHTML = ''; holidayRow.innerHTML = '';
            while(vRow.cells.length > 1) vRow.deleteCell(1);
            while(wRow.cells.length > 1) wRow.deleteCell(1);

            const holidayInfo = { 1: { 1: "ì‹ ì •" }, 2: { 16: "ì„¤ë‚ ", 17: "ì„¤ë‚ ", 18: "ì„¤ë‚ " }, 3: { 1: "ì‚¼ì¼ì ˆ" }, 5: { 5: "ì–´ë¦°ì´ë‚ ", 24: "ì„ê°€íƒ„ì‹ ì¼" }, 6: { 6: "í˜„ì¶©ì¼" }, 8: { 15: "ê´‘ë³µì ˆ" }, 10: { 3: "ê°œì²œì ˆ", 9: "í•œê¸€ë‚ " }, 12: { 25: "ì„±íƒ„ì ˆ" } }[currentMonth] || {};
            const weekDays = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            // 1ì¼ë¶€í„° 31ì¼ê¹Œì§€ ëª¨ë‘ ìƒì„±
            for (let d = 1; d <= 31; d++) {
                const dateObj = new Date(2026, currentMonth - 1, d);
                const isExist = dateObj.getMonth() === currentMonth - 1;
                const thD = document.createElement('th'); thD.className = 'col-day';
                const thW = document.createElement('th'); thW.className = 'col-day';
                const thH = document.createElement('th'); thH.className = 'col-day';

                if (isExist) {
                    const dayIdx = dateObj.getDay();
                    const hName = holidayInfo[d] || "";
                    thD.innerText = d; thW.innerText = weekDays[dayIdx]; thH.innerText = hName;
                    if(dayIdx === 0 || dayIdx === 6 || hName !== "") [thD, thW, thH].forEach(el => el.classList.add('txt-red'));
                }
                dateRow.appendChild(thD); weekRow.appendChild(thW); holidayRow.appendChild(thH);
                vRow.insertCell(-1).id = `vac-count-${d}`; wRow.insertCell(-1).id = `work-count-${d}`;
            }

            // ë¹„ê³  ì¹¸ ì¶”ê°€ (31ì¼ ë°”ë¡œ ì˜†)
            const noteTh = document.createElement('th');
            noteTh.innerText = "ë¹„ê³ "; noteTh.className = 'col-note';
            dateRow.appendChild(noteTh);
            weekRow.appendChild(document.createElement('th'));
            holidayRow.appendChild(document.createElement('th'));
            vRow.insertCell(-1); wRow.insertCell(-1);

            const list = (currentType === 'manager') ? masterData.manager : masterData.staff;
            list.forEach(p => {
                const tr = document.createElement('tr');
                tr.setAttribute('data-person', p.name);
                tr.innerHTML = `<td>${p.branch}</td><td>${p.name}</td><td>${p.req}</td><td>${p.unused}</td><td id="rem-${p.name}">${p.unused}</td><td id="rate-${p.name}">0%</td>`;
                
                for (let i = 1; i <= 31; i++) {
                    const dateObj = new Date(2026, currentMonth - 1, i);
                    const isExist = dateObj.getMonth() === currentMonth - 1;
                    const td = document.createElement('td'); td.className = 'at-cell col-day';
                    if (isExist) {
                        if (dateObj.getDay() === 0 || dateObj.getDay() === 6 || holidayInfo[i]) td.classList.add('bg-pink');
                        const match = attendance.find(r => r[0] == currentMonth && r[1] == currentType && r[2] == p.name && r[3] == i);
                        td.innerText = match ? match[4] : "";
                        if(td.innerText) applyStatusColor(td, td.innerText);
                        td.setAttribute('data-day', i);
                        td.onclick = function() { showDropdown(this, i, p.name); };
                    }
                    tr.appendChild(td);
                }

                const noteTd = document.createElement('td');
                const noteMatch = attendance.find(r => r[0] == currentMonth && r[1] == currentType && r[2] == p.name && r[3] == 32);
                noteTd.className = 'col-note';
                noteTd.innerHTML = `<input type="text" value="${noteMatch ? noteMatch[4] : ""}" placeholder="ë¹„ê³  ì…ë ¥" onchange="saveData(${currentMonth}, '${currentType}', '${p.name}', 32, this.value)">`;
                tr.appendChild(noteTd);
                tbody.appendChild(tr);
            });
            updateCounts();
        }

        function applyStatusColor(cell, status) {
            cell.style.color = ""; cell.style.fontWeight = "bold";
            if(status === 'ì—°ì°¨' || status === 'íœ´ê°€') cell.style.color = "#d32f2f";
            else if(status.includes('ë°˜ì°¨')) cell.style.color = "#ef6c00";
            else if(status === 'ë°˜ë°˜ì°¨') cell.style.color = "#4caf50";
        }

        function showDropdown(cell, day, name) {
            if (cell.querySelector('select')) return;
            const select = document.createElement('select');
            ['', 'ì—°ì°¨', 'ì˜¤ì „ë°˜ì°¨', 'ì˜¤í›„ë°˜ì°¨', 'ë°˜ë°˜ì°¨', 'íœ´ê°€', 'ì¶œì¥'].forEach(s => {
                const opt = document.createElement('option'); opt.value = s; opt.innerText = s || '-';
                if(s === cell.innerText) opt.selected = true;
                select.appendChild(opt);
            });
            select.onchange = function() {
                cell.innerText = this.value; applyStatusColor(cell, this.value);
                saveData(currentMonth, currentType, name, day, this.value); updateCounts();
            };
            cell.innerHTML = ''; cell.appendChild(select); select.focus();
        }

        async function saveData(m, t, n, d, s) {
            fetch(GAN_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ month: m, type: t, name: n, day: d, status: s }) });
        }

        function updateCounts() {
            const rows = document.querySelectorAll('#attendance-body tr');
            const dailyVacation = Array(33).fill(0);
            rows.forEach(row => {
                const name = row.getAttribute('data-person');
                let used = 0;
                row.querySelectorAll('.at-cell').forEach(c => {
                    const txt = c.innerText; if(!txt) return;
                    if (txt === 'ì—°ì°¨') used += 1; else if (txt === 'ë°˜ë°˜ì°¨') used += 0.25; else if (txt.includes('ë°˜ì°¨')) used += 0.5;
                    dailyVacation[parseInt(c.getAttribute('data-day'))] += 1;
                });
                const base = parseFloat(row.cells[3].innerText) || 0;
                const rem = base - used;
                document.getElementById(`rem-${name}`).innerText = Number.isInteger(rem) ? rem : rem.toFixed(2);
                const req = parseFloat(row.cells[2].innerText) || 0;
                document.getElementById(`rate-${name}`).innerText = req > 0 ? Math.floor((req - rem) / req * 100) + '%' : '0%';
            });
            for (let d = 1; d <= 31; d++) {
                const v = document.getElementById(`vac-count-${d}`); const w = document.getElementById(`work-count-${d}`);
                if (v && w) { v.innerText = dailyVacation[d]; w.innerText = rows.length - dailyVacation[d]; }
            }
        }

        function renderMonthPicker() {
            const container = document.getElementById('month-picker'); container.innerHTML = '';
            for (let m = 1; m <= 12; m++) {
                const btn = document.createElement('button'); btn.innerText = m + 'ì›”';
                btn.className = `month-btn ${m === currentMonth ? 'active' : ''}`;
                btn.onclick = () => { currentMonth = m; renderMonthPicker(); loadAllData(); };
                container.appendChild(btn);
            }
            if (!document.getElementById('btn-excel')) {
                const btn = document.createElement('button'); btn.id = 'btn-excel'; btn.innerText = 'ì—‘ì…€ ì €ì¥ ğŸ“¥';
                btn.style.cssText = "margin-left:20px; background:#2e7d32; color:white; border:none; padding:5px 12px; cursor:pointer; border-radius:4px; font-weight:bold; font-size:12px;";
                btn.onclick = () => { /* ì—‘ì…€ ì €ì¥ */ }; container.appendChild(btn);
            }
        }

        function switchTab(type) {
            currentType = type;
            document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');
            renderTable(lastFetchedAttendance);
        }
    </script>
</body>
</html>
